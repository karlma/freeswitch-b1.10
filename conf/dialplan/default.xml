<!-- http://wiki.freeswitch.org/wiki/Dialplan_XML --> 
<include>
  <context name="default">
    <extension name="intercept">
      <condition field="destination_number" expression="^886$">
	<action application="answer"/>
	<action application="intercept" data="${db(select/last_dial/global)}"/>
	<action application="sleep" data="2000"/>
      </condition>
    </extension>

    <extension name="intercept-ext">
      <condition field="destination_number" expression="^\*\*(\d+)$">
	<action application="answer"/>
	<action application="intercept" data="${db(select/last_dial_ext/$1)}"/>
	<action application="sleep" data="2000"/>
      </condition>
    </extension>

    <extension name="redial">
      <condition field="destination_number" expression="^870$">
	<action application="transfer" data="${db(select/last_dial/${caller_id_number})}"/>
      </condition>
    </extension>

    <extension name="global" continue="true">
      <condition field="${network_addr}" expression="^$">
	<action application="set" data="use_profile=${cond(${is_lan_addr($${local_ip_v4})} == yes ? nat : default)}"/>
	<anti-action application="set" data="use_profile=${cond(${is_lan_addr(${network_addr})} == yes ? nat : default)}"/>
      </condition>
      <!-- This will setup some variables if the user isn't authenticated.
	   numbering_plan is required for the demo to function properly. 
      -->
      <condition field="${numbering_plan}" condition="^$">
	<action application="set_user" data="default@${domain}"/>
      </condition>
      <condition>
	<action application="info"/>
	<action application="db" data="insert/spymap/${caller_id_number}/${uuid}"/>
	<action application="db" data="insert/last_dial/${caller_id_number}/${destination_number}"/>
	<action application="db" data="insert/last_dial/global/${uuid}"/>
      </condition>
    </extension>


    <extension name="eavesdrop">
      <condition field="destination_number" expression="^88(.*)$|^\*0(.*)$">
	<action application="answer"/>
	<action application="eavesdrop" data="${db(select/spymap/$1)}"/>
      </condition>
    </extension>

    <extension name="call_return">
      <condition field="destination_number" expression="^\*69$|^869$">
	<action application="transfer" data="${db(select/call_return/${caller_id_number})}"/>
      </condition>
    </extension>

    <extension name="del-group">
      <condition field="destination_number" expression="^80(\d{2})$">
	<action application="answer"/>
	<action application="group" data="delete:$1:${sofia_contact(${sip_from_user}@${domain})}"/>
	<action application="gentones" data="%(1000, 0, 320)"/>
      </condition>
    </extension>

    <extension name="add-group">
      <condition field="destination_number" expression="^81(\d{2})$">
	<action application="answer"/>
	<action application="group" data="insert:$1:${sofia_contact(${sip_from_user}@${domain})}"/>
	<action application="gentones" data="%(1000, 0, 640)"/>
      </condition>
    </extension>

    <extension name="call-group-simo">
      <condition field="destination_number" expression="^82(\d{2})$">
	<action application="bridge" data="${group(call:$1)}"/>
      </condition>
    </extension>

    <extension name="call-group-order">
      <condition field="destination_number" expression="^83(\d{2})$">
	<action application="set" data="call_timeout=10"/>
	<action application="bridge" data="${group(call:$1:order)}"/>
      </condition>
    </extension>

    <extension name="extension-intercom">
      <condition field="destination_number" expression="^8(10[01][0-9])$">
	<action application="set" data="dialed_ext=$1"/>
	<action application="set" data="sip_h_Call-Info=<sip:$${local_ip_v4}>;answer-after=0"/>
	<action application="set" data="sip_auto_answer=true"/>
	<action application="set" data="export_vars=sip_h_Call-Info,sip_auto_answer"/>
	<action application="bridge" data="user/${dialed_ext}@$${domain}"/>
      </condition>
    </extension>

    <!-- 
	 if the calling party is the called party, go to their VM
	 if the calling party is NOT the called party dial the extension 
	 (1000-1019) for 30 seconds and go to voicemail if the 
	 call fails (continue_on_fail=true), otherwise hang up after a 
	 successful bridge (hangup_after-bridge=true) 
    -->
    <extension name="Local_Extension">
      <condition field="destination_number" expression="^(10[01][0-9])$" continue="on-true">
	<action application="set" data="dialed_ext=$1"/>
      </condition>
      <condition field="destination_number" expression="^${caller_id_number}$">
	<action application="set" data="voicemail_authorized=${sip_authorized}"/>
	<action application="answer"/>
	<action application="sleep" data="1000"/>
	<action application="voicemail" data="check default $${domain} ${dialed_ext}"/>
	<anti-action application="set" data="transfer_ringback=${us-ring}"/>
	<anti-action application="set" data="call_timeout=30"/>
	<anti-action application="set" data="hangup_after_bridge=true"/>
	<anti-action application="set" data="left_hanging_extension=5900"/>
	<anti-action application="set" data="continue_on_fail=NORMAL_TEMPORARY_FAILURE,BUSY,USER_BUSY,NO_ANSWER,TIMEOUT"/>
	<anti-action application="db" data="insert/call_return/${dialed_ext}/${caller_id_number}"/>
	<anti-action application="db" data="insert/last_dial_ext/${dialed_ext}/${uuid}"/>
	<anti-action application="bridge" data="user/${dialed_ext}@$${domain}"/>
	<anti-action application="answer"/>
	<anti-action application="sleep" data="1000"/>
	<anti-action application="voicemail" data="default $${domain} ${dialed_ext}"/>
      </condition>
    </extension>

    <!-- dial via SIP uri -->
    <extension name="sip_uri">
      <condition field="destination_number" expression="^sip:(.*)$">
	<action application="bridge" data="sofia/${use_profile}/$1"/>
      </condition>
    </extension>

    <!--
	start a dynamic conference with the settings of the 
	"default" conference profile in conference.conf.xml
    -->                                                                                                                                                       
    <extension name="conferences">                                                                                                                           
      <condition field="destination_number" expression="^(3\d{3})$">
	<action application="conference" data="$1@default"/>
      </condition>
    </extension>           
    
    <!-- dial the freeswitch conference via SIP-->
    <extension name="freeswitch_public_conf_via_sip">
      <condition field="destination_number" expression="^9(888|1616)$">
	<action application="bridge" data="sofia/${use_profile}/$1@conference.freeswitch.org"/>
      </condition>
    </extension>

    <!-- a sample IVR  -->
    <extension name="ivr_demo">
      <condition field="destination_number" expression="5000">
	<action application="ivr" data="demo"/>
      </condition>
    </extension>
    
    
    <!-- 
	 Parking extensions... transferring calls to 5900-5909 will park them in a queue.
    -->
    <extension name="park">
      <condition field="destination_number" expression="^(590[0-9])$">
	<action application="fifo" data="$1@$${domain} in undef $${moh_uri}"/>
      </condition>
    </extension>
    <!-- 
	 The grandstream phone will subscribe to park+number and call **park+number to pickup.
    -->
    <extension name="unpark">
      <condition field="destination_number" expression="^\*{0,2}park\+(590[0-9])$">
	<action application="answer"/>
	<action application="fifo" data="$1@$${domain} out nowait"/>
      </condition>
    </extension> 

    <extension name="hold_music">
      <condition field="destination_number" expression="^9999$">
	<action application="answer"/>
	<action application="playback" data="$${moh_uri}"/>
      </condition>
    </extension>

    <X-PRE-PROCESS cmd="include" data="extensions/*.xml"/>

    <extension name="enum">
      <condition field="destination_number" expression="^(.*)$">
	<action application="transfer" data="$1 enum"/>
      </condition>
    </extension>
    
  </context>
</include>
